# 병행 프로세스 1

## 병행성과 병행 프로세스

- 병행성(Concurrency)
  - 여러 개의 프로세스 또는 쓰레드가 동시 수행되는 시스템의 특성
- 병행 프로세스
  - 동시 수행되는 여러 개의 프로세스 또는 쓰레드

### 병행 프로세스의 실행 형태

- 인터리빙(Interleaving): 여러 프로세스가 번갈아가며 실행되는 형태

![img.png](04_image/img.png)

- 여러 개의 CPU: 병렬 처리 형식

![img_1.png](04_image/img_1.png)

- 멀티프로세서 (다중 CPU) 시스템에서 메모리 구조에 따라 나뉜다.
  - 강결합 시스템 (공유 메모리 구조)
    - 하나의 시스템에서 여러 개의 CPU가 하나의 메모리를 공유 
    - ![img_2.png](04_image/img_2.png)
  - 약결합 시스템 (분산 메모리 구조)
    - 각각의 독립된 시스템이 네트워크로 연결되어 있는 구조
    - ![img_3.png](04_image/img_3.png)

### 프로세스 간의 관계

#### 독립 프로세스

- 수행 중인 다른 프로세스에 영향을 주지도 받지도 않음
- 데이터 및 상태를 다른 프로세스와 공유하지 않음
- 프로세스의 실행
  - 결정적: 실행결과는 입력에 의해서만 결정됨
  - 재상 가능: 같은 입력에 대해 항상 동일한 실행결과

#### 협력 프로세스

- 수행 중인 다른 프로세스와 영향을 주고 받음
- 데이터 및 상태를 다른 프로세스와 공유
- 프로세스의 실행
  - 비결정적: 실행결과는 실행순서에 좌우됨
  - 재생 불가능: 같은 입력에 대해 항상 동일한 실행결과를 보장하지 못함

## 병행성 문제

- 협력 프로세스인 경우 발생 가능한 문제
  - `상호배제`
  - `동기화`
  - `통신`

### 상호배제

- 2개 이상의 프로세스가 동시에 임계영역(critical section)을 수행하지 못하도록 하는 것

> 임계영역: 2개 이상의 프로세스가 동시에 사용하면 안 되는 공유자원을 접근하는 프로그램 코드 영역

![img_4.png](04_image/img_4.png)

- 빨간 네모 안에서 수행되는 코드들이 임계 영역이다.

### 동기화

- 2개 이상의 프로세스에 대한 처리순서를 결정하는 것
  - 프로세스 동기화
- 상호배제도 넓은 의미에서 임계영역에 대한 동기화 문제

![img_5.png](04_image/img_5.png)

- 정상 시나리오
  - 계좌1 에서 만원을 출금(출금 프로세스 실행)한 뒤 입금 프로세스 실행 후 계좌2에 만원 입금
- 동기화 문제 발생 시나리오
  - 출금 프로세스 실행 전에 입금 프로세스가 실행되고 계좌2에 만원에 입금, 계좌1에 만원이 출금되어야 하지만 출금이 되지 않았따.

### 통신 (이 다음 챕터에서 자세하게 살펴볼 예정)

- 프로세스들이 데이터를 공유하기 위해 반드시 필요
  - 프로세스 간 통신 (IPC)
- 통신 방법
  - 하나의 변수 사용
  - 메세지를 서로 주고받음

## 세마포어

- 상호배제와 동기화 문제를 해결하기 위한 도구
- Dijkstra(다익스트라)가 제안
- 정수형 공용변수
  - 저장값: 사용 가능한 자원의 수 또는 잠김이나 풀림의 상태를 나타냄
- 상황에 맞춰 0이상인 정수로 초기화 (상황에 따라서 0,1로 쓸 수도 있고 다양하게 사용 가능, 해당 강의에서만 0이상인 정수라고 가정)
- 두 기본연산 P와 V에 의해서만 사용됨
  - 기본연산: 인터럽트되지 않고 하나의 단위로 처리됨 (P와 V연산은 실행 도중에 끊기지 않는다는 의미)
- 세마포어마다 대기 큐 필요

### 연산 P

- 검사, 감소시키려는 시도

```c
void P(semaphore s) {
  if (s > 0) {
    s--;
  } else {
    //  현재 프로세스를 대기시킴
  }
}
```

### 연산 V

- 증가

```c
void V(semaphore s) {
  if (대기 중인 프로세스 없음) {
    s++;
  } else {
    // 대기 중인 프로세스 1개 실행;
  }
}
```

### 상호배제 해결 

- 상호배제를 위한 일반적인 요구사항
  1. 한 프로세스가 임계영역 수행 중 다른 프로세스는 임계영역에 진입해서는 안됨
  2. 임계영역 수행 중이던 프로세스가 임계영역을 빠져나온 후 다른 프로세스가 임계영역에 진입할 수 있어야 함
  3. 임계영역 진입 못하고 대기하는 프로세스는 적절한 시간 내에 임계영역을 수행을 시작할 수 있어야함

- 상호배제를 위한 임계영역 주변의 코드 영역
![img_6.png](04_image/img_6.png)
  - 진입영역: 임계영역에 대한 수행을 해도 되는지 체크
  - 해젱영역: 다른 프로세스가 임계영역 수행을 시작할 수 있도록 함

#### 세마포어를 이용한 상호배제 해결

![img_7.png](04_image/img_7.png)

- 세마포어 mutex 초깃값은 1
- 진입영역: P(mutex)
- 해제영역: V(mutex)
- 대기 큐는 FIFO 방식으로 관리

1) 실행 전

![img_12.png](04_image/img_12.png)

2) 프로세스 A가 P연산 수행
   - mutex 값이 0보다 크므로 mutex 값을 1 감소시킴

![img_14.png](04_image/img_14.png)

3) 프로세스 A가 임계영역 수행

![img_15.png](04_image/img_15.png)

4) 프로세스 B가 P연산 수행

![img_16.png](04_image/img_16.png)

![img_17.png](04_image/img_17.png)

5) 뮤텍스가 0이므로 프로세스 B가 대기 큐에 들어감

![img_18.png](04_image/img_18.png)

6) 프로세스 C가 P연산 수행, 뮤텍스 확인 후 뮤텍스가 0이므로 대기 큐에 들어감

![img_19.png](04_image/img_19.png)

![img_20.png](04_image/img_20.png)

![img_21.png](04_image/img_21.png)

7) 프로세스 A가 V연산 수행, 뮤텍스 확인 후 대기 중인 프로세스가 있으므로 대기중인 프로세스 중 하나를 실행

![img_23.png](04_image/img_23.png)

![img_24.png](04_image/img_24.png)

8) 프로세스 B가 임계영역 수행 후 V연산 수행

![img_25.png](04_image/img_25.png)

9) 대기 중인 프로세스가 있으므로 대기 중인 프로세스 C 실행

![img_26.png](04_image/img_26.png)

10) 프로세스 C가 임계영역 수행 후 V연산 수행

![img_27.png](04_image/img_27.png)

11) 프로세스 C의 V연산 수행 중 대기 중엔 프로세스가 없으므로 뮤텍스 값을 1증가 시킴

![img_28.png](04_image/img_28.png)

![img_29.png](04_image/img_29.png)

12) 종료

![img_30.png](04_image/img_30.png)

### 동기화 해결

#### 세마포어를 이용한 동기화 해결

- 상황 가정: 프로세스 A가 코드 s1을 수행한 후 프로세스 B가 코드 S2를 수행하도록 동기화해야 하는 상황
- `세마포어 mutex 초깃값은 0`

> A 프로세스 실행 후 B 프로세스 실행될 경우

1) 실행 전

![img_31.png](04_image/img_31.png)

2) 프로세스 A가 S1 수행

![img_32.png](04_image/img_32.png)

3) 프로세스 A가 V연산 수행

![img_33.png](04_image/img_33.png)

4) 대기 중인 프로세스가 없으므로 mutex 값 1 증가

![img_34.png](04_image/img_34.png)

5) 프로세스가 B가 P연산 수행

![img_35.png](04_image/img_35.png)

6) mutex 값이 1이므로 1 감소 후 S2 수행

![img_36.png](04_image/img_36.png)

![img_37.png](04_image/img_37.png)

> B 프로세스 실행 후 A 프로세스 실행될 경우

1) 실행 전

![img_31.png](04_image/img_31.png)

2) 프로세스 B가 P연산 수행

![img_38.png](04_image/img_38.png)

3) mutex 값이 0이므로 대기 큐에 들어감

![img_39.png](04_image/img_39.png)

4) 프로세스 A가 S1 수행 후 V연산 수행

![img_40.png](04_image/img_40.png)

5) 대기 중인 프로세스가 있으므로 대기 중인 프로세스 하나 실행

![img_41.png](04_image/img_41.png)

